name: Ralph Wiggum AIRC Coordination

on:
  schedule:
    # Run every night at 2am PT (10am UTC)
    - cron: '0 10 * * *'
  workflow_dispatch: # Manual trigger
    inputs:
      max_iterations:
        description: 'Max iterations'
        required: false
        default: '10'

permissions:
  contents: write
  pull-requests: write

jobs:
  ralph:
    runs-on: ubuntu-latest
    timeout-minutes: 180 # 3 hours max

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create Ralph branch
        run: |
          git config user.name "Ralph Wiggum Bot"
          git config user.email "ralph@vibecodings.dev"
          BRANCH_NAME="ralph-maintenance-$(date +%Y%m%d)"
          git checkout -b $BRANCH_NAME || git checkout $BRANCH_NAME

      - name: Run Ralph maintenance loop with AIRC coordination
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          chmod +x scripts/ralph-maintain.sh scripts/ralph-status.sh scripts/ralph-route-task.sh
          MAX_ITER="${{ github.event.inputs.max_iterations || '10' }}"
          ./scripts/ralph-maintain.sh MAINTENANCE_PRD.json $MAX_ITER
        continue-on-error: true

      - name: Push changes
        run: |
          BRANCH_NAME="ralph-maintenance-$(date +%Y%m%d)"
          git push origin $BRANCH_NAME --force
        continue-on-error: true

      - name: Check if changes were made
        id: check_changes
        run: |
          BRANCH_NAME="ralph-maintenance-$(date +%Y%m%d)"
          BASE_BRANCH="main"

          # Try main, fallback to master or current branch
          if ! git rev-parse --verify origin/main &>/dev/null; then
            if git rev-parse --verify origin/master &>/dev/null; then
              BASE_BRANCH="master"
            else
              BASE_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            fi
          fi

          if [ -n "$(git log origin/$BASE_BRANCH..$BRANCH_NAME 2>/dev/null)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          fi

      - name: Generate agent summary
        if: steps.check_changes.outputs.has_changes == 'true'
        id: agent_summary
        run: |
          COMPLETED=$(jq '.tasks[] | select(.status == "complete" and .completedAt != null) | select(.completedAt > "'$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-24H +%Y-%m-%dT%H:%M:%SZ)'")' MAINTENANCE_PRD.json || echo "[]")

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          if [ "$COMPLETED" != "[]" ]; then
            echo "$COMPLETED" | jq -r '"- âœ… **\(.id)** (\(.completedBy // "@ralph")) - \(.description)"'
          else
            echo "- No tasks completed this run"
          fi
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ralph-maintenance-$(date +%Y%m%d)
          base: ${{ steps.check_changes.outputs.base_branch }}
          title: "ðŸ¤– Ralph's AIRC maintenance - $(date +%Y-%m-%d)"
          body: |
            ## Ralph Wiggum Autonomous Maintenance + AIRC Coordination

            "I'm helping... by delegating to experts!" ðŸ¤–

            ### Summary
            Ralph coordinated with /vibe's agent ecosystem overnight.

            ### Tasks Completed
            ${{ steps.agent_summary.outputs.summary }}

            ### Agent Ecosystem
            See `.ralph/progress.txt` for full activity log showing which agents contributed.

            ### Tests
            All tests passing: âœ…

            ### AIRC Integration
            - Tasks routed to specialist agents (@ops-agent, @bridges-agent, etc.)
            - Coordination via `vibe_handoff` protocol
            - Ed25519 signed handoffs
            - Full audit trail

            ### Review Checklist
            - [ ] Code quality looks good
            - [ ] Tests are comprehensive
            - [ ] Documentation updated
            - [ ] No security issues
            - [ ] Agent attributions correct

            ---
            Generated by [Ralph Wiggum AIRC](https://github.com/${{ github.repository }}/blob/main/RALPH_AGENT_COORDINATION.md)

      - name: Summary
        run: |
          echo "## Ralph AIRC Coordination Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          bash scripts/ralph-status.sh >> $GITHUB_STEP_SUMMARY
